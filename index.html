<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Desejos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'red-custom': {
                            50: '#fef2f2', 
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(220, 38, 38, 0.15);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 0;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #dc2626;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-red-50 to-white min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-8 mb-8">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center mb-6">
                <!-- Bot√£o de perfil/usu√°rio -->
                <div class="flex items-center space-x-4">
                    <div id="userInfo" class="hidden">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <span id="userInitial" class="text-red-600 font-bold text-lg"></span>
                            </div>
                            <div class="text-left">
                                <div id="userName" class="font-semibold"></div>
                                <div id="userEmail" class="text-sm opacity-75"></div>
                            </div>
                        </div>
                    </div>
                    
                    <button 
                        id="loginButton" 
                        onclick="window.location.href='auth.html'"
                        class="bg-white bg-opacity-20 hover:bg-opacity-30 px-6 py-2 rounded-xl font-semibold transition-all duration-200"
                    >
                        üîê Entrar
                    </button>
                </div>
                
                <!-- Bot√µes de a√ß√£o -->
                <div class="flex items-center space-x-4">
                    <button 
                        id="notificationsButton"
                        onclick="toggleNotifications()"
                        class="bg-white bg-opacity-20 hover:bg-opacity-30 p-3 rounded-xl transition-all duration-200 relative"
                    >
                        üîî
                        <span id="notificationBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>
                    
                    <button 
                        id="shareButton"
                        onclick="shareList()"
                        class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-xl font-semibold transition-all duration-200"
                    >
                        üì§ Compartilhar
                    </button>
                    
                    <button 
                        id="logoutButton"
                        onclick="logout()"
                        class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-xl font-semibold transition-all duration-200 hidden"
                    >
                        üö™ Sair
                    </button>
                </div>
            </div>
            
            <div class="text-center">
                <h1 class="text-5xl md:text-6xl font-bold mb-4 drop-shadow-lg">
                     Whitelist
                </h1>
                <p class="text-xl md:text-2xl opacity-90">
                    Itens que eu quero comprar
                </p>
                <div class="mt-4 text-sm opacity-75">
                    ‚ú® Dados salvos na nuvem - compartilhado com todos!
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 max-w-7xl">
        <!-- Formul√°rio para adicionar itens -->
        <div class="bg-white rounded-3xl shadow-xl p-8 mb-8 border border-red-100">
            <h2 class="text-3xl font-bold text-red-600 text-center mb-8">
                ‚ú® Adicionar Novo Item
            </h2>
            
            <form id="addItemForm" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-red-600 font-semibold mb-3 text-lg">
                            Nome do Item *
                        </label>
                        <input 
                            type="text" 
                            id="itemTitle" 
                            required 
                            placeholder="Ex: iPhone 15 Pro Max"
                            class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:border-red-500 focus:outline-none transition-colors text-gray-700"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-red-600 font-semibold mb-3 text-lg">
                            Pre√ßo
                        </label>
                        <input 
                            type="text" 
                            id="itemPrice" 
                            placeholder="R$ 0,00"
                            class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:border-red-500 focus:outline-none transition-colors text-gray-700"
                        >
                    </div>
                </div>
                
                <div>
                    <label class="block text-red-600 font-semibold mb-3 text-lg">
                        Descri√ß√£o
                    </label>
                    <textarea 
                        id="itemDescription" 
                        rows="3" 
                        placeholder="Descreva o item, especifica√ß√µes, cor preferida..."
                        class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:border-red-500 focus:outline-none transition-colors text-gray-700 resize-none"
                    ></textarea>
                </div>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-red-600 font-semibold mb-3 text-lg">
                            URL da Imagem
                        </label>
                        <input 
                            type="url" 
                            id="itemImage" 
                            placeholder="https://exemplo.com/imagem.jpg"
                            class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:border-red-500 focus:outline-none transition-colors text-gray-700"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-red-600 font-semibold mb-3 text-lg">
                            Link para Compra
                        </label>
                        <input 
                            type="url" 
                            id="itemLink" 
                            placeholder="https://exemplo.com/produto"
                            class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:border-red-500 focus:outline-none transition-colors text-gray-700"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-red-600 font-semibold mb-3 text-lg">
                            Categoria *
                        </label>
                        <select 
                            id="itemCategory" 
                            required
                            class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:border-red-500 focus:outline-none transition-colors text-gray-700"
                        >
                            <option value="">Selecione uma categoria</option>
                            <option value="eletronicos">üéÆ Eletr√¥nicos</option>
                            <option value="roupas">üëï Roupas</option>
                            <option value="livros">üìö Livros</option>
                            <option value="casa">üè† Casa</option>
                            <option value="esportes">‚öΩ Esportes</option>
                            <option value="beleza">üíÑ Beleza</option>
                            <option value="outros">üéÅ Outros</option>
                        </select>
                    </div>
                </div>
                
                <div class="text-center">
                    <button 
                        type="submit" 
                        id="submitButton"
                        class="gradient-bg text-white px-12 py-4 rounded-2xl text-xl font-semibold hover:scale-105 transition-transform duration-200 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        üéÅ Adicionar √† Lista
                    </button>
                </div>
            </form>
        </div>

        <!-- Estat√≠sticas -->
        <div class="bg-white rounded-3xl shadow-lg p-6 mb-8 border border-red-100">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                <div class="p-4">
                    <div class="text-3xl font-bold text-red-600" id="totalItems">0</div>
                    <div class="text-gray-600">Total de Itens</div>
                </div>
                <div class="p-4">
                    <div class="text-3xl font-bold text-red-600" id="totalValue">R$ 0,00</div>
                    <div class="text-gray-600">Valor Total</div>
                </div>
                <div class="p-4">
                    <div class="text-3xl font-bold text-red-600" id="completedItems">0</div>
                    <div class="text-gray-600">Itens Comprados</div>
                </div>
            </div>
        </div>

        <!-- Filtros e Busca -->
        <div class="bg-white rounded-3xl shadow-lg p-6 mb-8 border border-red-100">
            <h3 class="text-2xl font-bold text-red-600 mb-6 text-center">
                üîç Filtros e Busca
            </h3>
            
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Busca por texto -->
                <div>
                    <label class="block text-red-600 font-semibold mb-3">
                        Buscar por nome
                    </label>
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Digite para buscar..."
                        class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:border-red-500 focus:outline-none transition-colors text-gray-700"
                    >
                </div>
                
                <!-- Filtro por categoria -->
                <div>
                    <label class="block text-red-600 font-semibold mb-3">
                        Filtrar por categoria
                    </label>
                    <select 
                        id="categoryFilter" 
                        class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:border-red-500 focus:outline-none transition-colors text-gray-700"
                    >
                        <option value="">Todas as categorias</option>
                        <option value="eletronicos">üéÆ Eletr√¥nicos</option>
                        <option value="roupas">üëï Roupas</option>
                        <option value="livros">üìö Livros</option>
                        <option value="casa">üè† Casa</option>
                        <option value="esportes">‚öΩ Esportes</option>
                        <option value="beleza">üíÑ Beleza</option>
                        <option value="outros">üéÅ Outros</option>
                    </select>
                </div>
                
                <!-- Filtro por status -->
                <div>
                    <label class="block text-red-600 font-semibold mb-3">
                        Filtrar por status
                    </label>
                    <select 
                        id="statusFilter" 
                        class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:border-red-500 focus:outline-none transition-colors text-gray-700"
                    >
                        <option value="">Todos os itens</option>
                        <option value="available">üõí Dispon√≠vel</option>
                        <option value="completed">‚úÖ Comprado</option>
                    </select>
                </div>
            </div>
            
                    <!-- Bot√µes de a√ß√£o -->
        <div class="flex justify-center mt-6 space-x-4">
            <button 
                onclick="applyFilters()" 
                class="gradient-bg text-white px-8 py-3 rounded-xl font-semibold hover:scale-105 transition-transform duration-200 shadow-lg"
            >
                üîç Aplicar Filtros
            </button>
            
            <button 
                onclick="clearFilters()" 
                class="bg-gray-500 text-white px-8 py-3 rounded-xl font-semibold hover:bg-gray-600 transition-colors shadow-lg"
            >
                üóëÔ∏è Limpar Filtros
            </button>
        </div>
    </div>

    <!-- Notifica√ß√µes -->
    <div id="notificationsPanel" class="bg-white rounded-3xl shadow-lg p-6 mb-8 border border-red-100 hidden">
        <h3 class="text-2xl font-bold text-red-600 mb-6 text-center">
            üîî Notifica√ß√µes
        </h3>
        
        <div id="notificationsList" class="space-y-4">
            <!-- Notifica√ß√µes ser√£o adicionadas aqui dinamicamente -->
        </div>
        
        <div class="text-center mt-6">
            <button 
                onclick="markAllNotificationsAsRead()"
                class="bg-gray-500 text-white px-6 py-2 rounded-xl font-semibold hover:bg-gray-600 transition-colors"
            >
                ‚úÖ Marcar todas como lidas
            </button>
        </div>
    </div>

    <!-- Hist√≥rico de Mudan√ßas -->
    <div class="bg-white rounded-3xl shadow-lg p-6 mb-8 border border-red-100">
        <h3 class="text-2xl font-bold text-red-600 mb-6 text-center">
            üìù Hist√≥rico de Mudan√ßas
        </h3>
        
        <div class="grid md:grid-cols-2 gap-6">
            <!-- Filtros do hist√≥rico -->
            <div>
                <label class="block text-red-600 font-semibold mb-3">
                    Filtrar por a√ß√£o
                </label>
                <select 
                    id="historyActionFilter" 
                    class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:border-red-500 focus:outline-none transition-colors text-gray-700"
                >
                    <option value="">Todas as a√ß√µes</option>
                    <option value="created">‚ûï Criado</option>
                    <option value="updated">‚úèÔ∏è Atualizado</option>
                    <option value="deleted">üóëÔ∏è Removido</option>
                    <option value="completed">‚úÖ Marcado como comprado</option>
                </select>
            </div>
            
            <div>
                <label class="block text-red-600 font-semibold mb-3">
                    Filtrar por per√≠odo
                </label>
                <select 
                    id="historyPeriodFilter" 
                    class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:border-red-500 focus:outline-none transition-colors text-gray-700"
                >
                    <option value="7">√öltimos 7 dias</option>
                    <option value="30">√öltimos 30 dias</option>
                    <option value="90">√öltimos 3 meses</option>
                    <option value="all">Todo o hist√≥rico</option>
                </select>
            </div>
        </div>
        
        <div id="historyList" class="mt-6 space-y-4 max-h-96 overflow-y-auto">
            <!-- Hist√≥rico ser√° carregado aqui -->
        </div>
        
        <div class="text-center mt-6">
            <button 
                onclick="loadHistory()"
                class="gradient-bg text-white px-8 py-3 rounded-xl font-semibold hover:scale-105 transition-transform duration-200 shadow-lg"
            >
                üîÑ Atualizar Hist√≥rico
            </button>
        </div>
    </div>

        <!-- Loading state -->
        <div id="loadingState" class="text-center py-20">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-gray-600">Carregando lista de desejos...</p>
        </div>

        <!-- Grade de itens -->
        <div id="wishlistGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-8 hidden">
            <!-- Os itens ser√£o adicionados aqui dinamicamente -->
        </div>

        <!-- Estado vazio -->
        <div id="emptyState" class="text-center py-20 hidden">
            <div class="text-8xl mb-6">üìù</div>
            <h3 class="text-3xl font-bold text-red-600 mb-4">
                Sua lista est√° vazia
            </h3>
            <p class="text-xl text-gray-600">
                Use o formul√°rio acima para adicionar seus primeiros desejos!
            </p>
        </div>
    </div>

    <!-- Modal para visualizar item -->
    <div id="itemModal" class="modal">
        <div class="modal-content w-full md:w-auto">
            <div class="relative">
                <!-- Bot√£o fechar -->
                <button 
                    onclick="closeModal()" 
                    class="absolute top-4 right-4 z-10 bg-white rounded-full p-2 shadow-lg hover:bg-gray-100 transition-colors"
                >
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                
                <div class="grid md:grid-cols-2 gap-0">
                    <!-- Imagem do item -->
                    <div class="bg-gray-100 min-h-[400px] flex items-center justify-center">
                        <img id="modalImage" src="" alt="" class="w-full h-full object-cover">
                        <div id="modalNoImage" class="text-gray-400 text-center hidden">
                            <svg class="w-24 h-24 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <p>Sem imagem</p>
                        </div>
                    </div>
                    
                    <!-- Informa√ß√µes do item -->
                    <div class="p-8 bg-white">
                        <h2 id="modalTitle" class="text-3xl font-bold text-red-600 mb-4"></h2>
                        
                        <div id="modalPrice" class="text-2xl font-bold text-red-600 mb-6 hidden"></div>
                        
                        <div id="modalDescription" class="text-gray-700 text-lg mb-8 hidden"></div>
                        
                        <div class="space-y-4">
                            <button 
                                id="modalBuyButton" 
                                onclick="openBuyLink()" 
                                class="w-full gradient-bg text-white py-4 px-6 rounded-2xl text-xl font-semibold hover:scale-105 transition-transform duration-200 shadow-lg"
                            >
                                üõí Comprar Agora
                            </button>
                            
                            <button 
                                onclick="markAsCompleted()" 
                                class="w-full bg-green-500 text-white py-4 px-6 rounded-2xl text-xl font-semibold hover:bg-green-600 transition-colors shadow-lg"
                            >
                                ‚úÖ Marcar como Comprado
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);
        
        // Vari√°veis globais
        let wishlistItems = [];
        let currentModalItem = null;
        let currentUser = null;
        let notifications = [];
        let historyItems = [];
        
        // Verificar autentica√ß√£o ao carregar
        async function checkAuth() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            
            if (user) {
                currentUser = user;
                showUserInfo();
                loadNotifications();
                loadHistory();
            } else {
                // Redirecionar para login se n√£o estiver autenticado
                window.location.href = 'auth.html';
            }
        }
        
        // Mostrar informa√ß√µes do usu√°rio
        function showUserInfo() {
            if (currentUser) {
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('loginButton').classList.add('hidden');
                document.getElementById('logoutButton').classList.remove('hidden');
                
                const name = currentUser.user_metadata?.full_name || 'Usu√°rio';
                const email = currentUser.email;
                
                document.getElementById('userName').textContent = name;
                document.getElementById('userEmail').textContent = email;
                document.getElementById('userInitial').textContent = name.charAt(0).toUpperCase();
            }
        }
        
        // Logout
        async function logout() {
            try {
                await supabaseClient.auth.signOut();
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
            }
        }

        // Fun√ß√£o para adicionar um novo item
        async function addWishItem(item) {
            try {
                const submitButton = document.getElementById('submitButton');
                submitButton.disabled = true;
                submitButton.innerHTML = '<div class="loading mx-auto"></div> Salvando...';
                
                const { data, error } = await supabaseClient
                    .from('wishlist_items')
                    .insert([{
                        title: item.title,
                        description: item.description || null,
                        price: item.price || null,
                        image_url: item.image || null,
                        buy_link: item.link || null,
                        category: item.category || null,
                        completed: false,
                        user_id: currentUser.id
                    }])
                    .select();

                if (error) throw error;

                // Adicionar o item √† lista local
                const newItem = {
                    id: data[0].id,
                    title: item.title,
                    description: item.description,
                    price: item.price,
                    image: item.image,
                    link: item.link,
                    category: item.category,
                    completed: false,
                    dateAdded: new Date().toISOString()
                };
                
                wishlistItems.push(newItem);
                renderWishlist();
                updateStats();
                
                // Adicionar ao hist√≥rico
                await addHistoryEntry('created', item.title);
                
                // Criar notifica√ß√£o
                await createNotification('Item Adicionado', `"${item.title}" foi adicionado √† sua lista`);
                
                // Feedback visual
                submitButton.innerHTML = '‚úÖ Adicionado!';
                submitButton.classList.add('bg-green-500');
                
                setTimeout(() => {
                    submitButton.innerHTML = 'üéÅ Adicionar √† Lista';
                    submitButton.classList.remove('bg-green-500');
                    submitButton.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Erro ao adicionar item:', error);
                alert('Erro ao adicionar item. Tente novamente.');
                submitButton.innerHTML = 'üéÅ Adicionar √† Lista';
                submitButton.disabled = false;
            }
        }

        // Fun√ß√£o para carregar itens do Supabase
        async function loadWishlistFromSupabase() {
            try {
                const { data, error } = await supabaseClient
                    .from('wishlist_items')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                wishlistItems = data.map(item => ({
                    id: item.id,
                    title: item.title,
                    description: item.description,
                    price: item.price,
                    image: item.image_url,
                    link: item.buy_link,
                    category: item.category || 'outros',
                    completed: item.completed,
                    dateAdded: item.created_at
                }));

                renderWishlist();
                updateStats();
                
                // Esconder loading e mostrar conte√∫do
                document.getElementById('loadingState').classList.add('hidden');
                
            } catch (error) {
                console.error('Erro ao carregar lista:', error);
                document.getElementById('loadingState').innerHTML = `
                    <div class="text-red-600 text-center">
                        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                        <h3 class="text-xl font-bold mb-2">Erro ao carregar lista</h3>
                        <p class="text-gray-600">Verifique sua conex√£o e tente novamente</p>
                        <button onclick="loadWishlistFromSupabase()" class="mt-4 px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        // Fun√ß√£o para renderizar a lista
        function renderWishlist() {
            const grid = document.getElementById('wishlistGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (wishlistItems.length === 0) {
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            grid.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            grid.innerHTML = wishlistItems.map((item, index) => `
                <div class="bg-white rounded-3xl shadow-lg p-6 border border-red-100 card-hover fade-in ${item.completed ? 'opacity-60' : ''}">
                    ${item.image ? 
                        `<img src="${item.image}" alt="${item.title}" class="w-full h-48 object-cover rounded-2xl mb-4 border-2 border-red-100" onerror="this.style.display='none'">` : 
                        `<div class="w-full h-48 bg-red-50 rounded-2xl mb-4 flex items-center justify-center border-2 border-red-100">
                            <svg class="w-16 h-16 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>`
                    }
                    
                    <h3 class="text-xl font-bold text-red-600 mb-3 ${item.completed ? 'line-through' : ''}">
                        ${item.title}
                    </h3>
                    
                    <!-- Categoria -->
                    <div class="mb-3">
                        <span class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-semibold">
                            ${getCategoryIcon(item.category)} ${getCategoryName(item.category)}
                        </span>
                    </div>
                    
                    ${item.description ? `<p class="text-gray-600 mb-3 line-clamp-2">${item.description}</p>` : ''}
                    
                    ${item.price ? `<p class="text-lg font-bold text-red-600 mb-4">${item.price}</p>` : ''}
                    
                    <div class="flex space-x-3">
                        <button 
                            onclick="viewItem(${index})" 
                            class="flex-1 gradient-bg text-white py-3 px-4 rounded-xl font-semibold hover:scale-105 transition-transform duration-200"
                        >
                            üëÅÔ∏è Ver Detalhes
                        </button>
                        
                        <button 
                            onclick="removeItem(${index})" 
                            class="bg-red-500 text-white py-3 px-4 rounded-xl font-semibold hover:bg-red-600 transition-colors"
                        >
                            üóëÔ∏è
                        </button>
                    </div>
                    
                    ${item.completed ? 
                        `<div class="mt-4 text-center">
                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                ‚úÖ Comprado
                            </span>
                        </div>` : ''
                    }
                </div>
            `).join('');
        }

        // Fun√ß√£o para visualizar item no modal
        function viewItem(index) {
            const item = wishlistItems[index];
            currentModalItem = index;
            
            // Preencher o modal
            document.getElementById('modalTitle').textContent = item.title;
            
            if (item.price) {
                document.getElementById('modalPrice').textContent = item.price;
                document.getElementById('modalPrice').classList.remove('hidden');
            } else {
                document.getElementById('modalPrice').classList.add('hidden');
            }
            
            if (item.description) {
                document.getElementById('modalDescription').textContent = item.description;
                document.getElementById('modalDescription').classList.remove('hidden');
            } else {
                document.getElementById('modalDescription').classList.add('hidden');
            }
            
            if (item.image) {
                document.getElementById('modalImage').src = item.image;
                document.getElementById('modalImage').classList.remove('hidden');
                document.getElementById('modalNoImage').classList.add('hidden');
            } else {
                document.getElementById('modalImage').classList.add('hidden');
                document.getElementById('modalNoImage').classList.remove('hidden');
            }
            
            // Mostrar/esconder bot√£o de compra
            if (item.link) {
                document.getElementById('modalBuyButton').classList.remove('hidden');
            } else {
                document.getElementById('modalBuyButton').classList.add('hidden');
            }
            
            // Abrir modal
            document.getElementById('itemModal').classList.add('show');
        }

        // Fun√ß√£o para fechar modal
        function closeModal() {
            document.getElementById('itemModal').classList.remove('show');
            currentModalItem = null;
        }

        // Fun√ß√£o para abrir link de compra
        function openBuyLink() {
            if (currentModalItem !== null && wishlistItems[currentModalItem].link) {
                window.open(wishlistItems[currentModalItem].link, '_blank');
            }
        }

        // Fun√ß√£o para marcar como comprado
        async function markAsCompleted() {
            if (currentModalItem !== null) {
                try {
                    const item = wishlistItems[currentModalItem];
                    const newCompletedStatus = !item.completed;
                    
                    const { error } = await supabaseClient
                        .from('wishlist_items')
                        .update({ completed: newCompletedStatus })
                        .eq('id', item.id);

                    if (error) throw error;

                    // Atualizar localmente
                    item.completed = newCompletedStatus;
                    renderWishlist();
                    updateStats();
                    
                    // Adicionar ao hist√≥rico
                    await addHistoryEntry('completed', item.title);
                    
                    // Criar notifica√ß√£o
                    const statusText = newCompletedStatus ? 'comprado' : 'dispon√≠vel';
                    await createNotification('Status Atualizado', `"${item.title}" foi marcado como ${statusText}`);
                    
                    closeModal();
                    
                } catch (error) {
                    console.error('Erro ao atualizar status:', error);
                    alert('Erro ao atualizar status. Tente novamente.');
                }
            }
        }

        // Fun√ß√£o para remover um item
        async function removeItem(index) {
            if (confirm('Tem certeza que deseja remover este item?')) {
                try {
                    const item = wishlistItems[index];
                    
                    const { error } = await supabaseClient
                        .from('wishlist_items')
                        .delete()
                        .eq('id', item.id);

                    if (error) throw error;

                    // Remover localmente
                    wishlistItems.splice(index, 1);
                    renderWishlist();
                    updateStats();
                    
                    // Adicionar ao hist√≥rico
                    await addHistoryEntry('deleted', item.title);
                    
                    // Criar notifica√ß√£o
                    await createNotification('Item Removido', `"${item.title}" foi removido da sua lista`);
                    
                } catch (error) {
                    console.error('Erro ao remover item:', error);
                    alert('Erro ao remover item. Tente novamente.');
                }
            }
        }

        // Fun√ß√£o para atualizar estat√≠sticas
        function updateStats() {
            const totalItems = wishlistItems.length;
            const completedItems = wishlistItems.filter(item => item.completed).length;
            
            // Calcular valor total
            let totalValue = 0;
            wishlistItems.forEach(item => {
                if (item.price) {
                    const price = item.price.replace(/[^\d,]/g, '').replace(',', '.');
                    if (!isNaN(parseFloat(price))) {
                        totalValue += parseFloat(price);
                    }
                }
            });
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('completedItems').textContent = completedItems;
            document.getElementById('totalValue').textContent = `R$ ${totalValue.toFixed(2).replace('.', ',')}`;
        }

        // Fun√ß√µes auxiliares para categorias
        function getCategoryIcon(category) {
            const icons = {
                'eletronicos': 'üéÆ',
                'roupas': 'üëï',
                'livros': 'üìö',
                'casa': 'üè†',
                'esportes': '‚öΩ',
                'beleza': 'üíÑ',
                'outros': 'üéÅ'
            };
            return icons[category] || 'üéÅ';
        }

        function getCategoryName(category) {
            const names = {
                'eletronicos': 'Eletr√¥nicos',
                'roupas': 'Roupas',
                'livros': 'Livros',
                'casa': 'Casa',
                'esportes': 'Esportes',
                'beleza': 'Beleza',
                'outros': 'Outros'
            };
            return names[category] || 'Outros';
        }

        // Fun√ß√µes de filtro
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filteredItems = wishlistItems.filter(item => {
                // Filtro por texto
                const matchesSearch = !searchTerm || 
                    item.title.toLowerCase().includes(searchTerm) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm));
                
                // Filtro por categoria
                const matchesCategory = !categoryFilter || item.category === categoryFilter;
                
                // Filtro por status
                const matchesStatus = !statusFilter || 
                    (statusFilter === 'available' && !item.completed) ||
                    (statusFilter === 'completed' && item.completed);
                
                return matchesSearch && matchesCategory && matchesStatus;
            });
            
            renderFilteredItems(filteredItems);
        }

        function renderFilteredItems(filteredItems) {
            const grid = document.getElementById('wishlistGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredItems.length === 0) {
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                emptyState.innerHTML = `
                    <div class="text-8xl mb-6">üîç</div>
                    <h3 class="text-3xl font-bold text-red-600 mb-4">
                        Nenhum item encontrado
                    </h3>
                    <p class="text-xl text-gray-600">
                        Tente ajustar os filtros ou adicionar novos itens!
                    </p>
                `;
                return;
            }
            
            grid.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            grid.innerHTML = filteredItems.map((item, index) => `
                <div class="bg-white rounded-3xl shadow-lg p-6 border border-red-100 card-hover fade-in ${item.completed ? 'opacity-60' : ''}">
                    ${item.image ? 
                        `<img src="${item.image}" alt="${item.title}" class="w-full h-48 object-cover rounded-2xl mb-4 border-2 border-red-100" onerror="this.style.display='none'">` : 
                        `<div class="w-full h-48 bg-red-50 rounded-2xl mb-4 flex items-center justify-center border-2 border-red-100">
                            <svg class="w-16 h-16 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>`
                    }
                    
                    <h3 class="text-xl font-bold text-red-600 mb-3 ${item.completed ? 'line-through' : ''}">
                        ${item.title}
                    </h3>
                    
                    <!-- Categoria -->
                    <div class="mb-3">
                        <span class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-2xl text-sm font-semibold">
                            ${getCategoryIcon(item.category)} ${getCategoryName(item.category)}
                        </span>
                    </div>
                    
                    ${item.description ? `<p class="text-gray-600 mb-3 line-clamp-2">${item.description}</p>` : ''}
                    
                    ${item.price ? `<p class="text-lg font-bold text-red-600 mb-4">${item.price}</p>` : ''}
                    
                    <div class="flex space-x-3">
                        <button 
                            onclick="viewItem(${index})" 
                            class="flex-1 gradient-bg text-white py-3 px-4 rounded-xl font-semibold hover:scale-105 transition-transform duration-200"
                        >
                            üëÅÔ∏è Ver Detalhes
                        </button>
                        
                        <button 
                            onclick="removeItem(${index})" 
                            class="bg-red-500 text-white py-3 px-4 rounded-xl font-semibold hover:bg-red-600 transition-colors"
                        >
                            üóëÔ∏è
                        </button>
                    </div>
                    
                    ${item.completed ? 
                        `<div class="mt-4 text-center">
                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                ‚úÖ Comprado
                            </span>
                        </div>` : ''
                    }
                </div>
            `).join('');
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('statusFilter').value = '';
            renderWishlist();
        }

        // Sistema de Notifica√ß√µes
        async function loadNotifications() {
            try {
                const { data, error } = await supabaseClient
                    .from('notifications')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('read', false)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                notifications = data || [];
                updateNotificationBadge();
                renderNotifications();
                
            } catch (error) {
                console.error('Erro ao carregar notifica√ß√µes:', error);
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (notifications.length > 0) {
                badge.textContent = notifications.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function renderNotifications() {
            const list = document.getElementById('notificationsList');
            
            if (notifications.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center">Nenhuma notifica√ß√£o</p>';
                return;
            }
            
            list.innerHTML = notifications.map(notification => `
                <div class="bg-gray-50 rounded-xl p-4 border-l-4 border-red-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-gray-800">${notification.title}</h4>
                            <p class="text-gray-600 text-sm">${notification.message}</p>
                            <p class="text-gray-400 text-xs mt-2">${formatDate(notification.created_at)}</p>
                        </div>
                        <button 
                            onclick="markNotificationAsRead('${notification.id}')"
                            class="text-red-500 hover:text-red-700 text-sm"
                        >
                            ‚úï
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function markNotificationAsRead(notificationId) {
            try {
                const { error } = await supabaseClient
                    .from('notifications')
                    .update({ read: true })
                    .eq('id', notificationId);

                if (error) throw error;

                // Remover da lista local
                notifications = notifications.filter(n => n.id !== notificationId);
                updateNotificationBadge();
                renderNotifications();
                
            } catch (error) {
                console.error('Erro ao marcar notifica√ß√£o como lida:', error);
            }
        }

        async function markAllNotificationsAsRead() {
            try {
                const { error } = await supabaseClient
                    .from('notifications')
                    .update({ read: true })
                    .eq('user_id', currentUser.id)
                    .eq('read', false);

                if (error) throw error;

                notifications = [];
                updateNotificationBadge();
                renderNotifications();
                
            } catch (error) {
                console.error('Erro ao marcar todas como lidas:', error);
            }
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('hidden');
        }

        // Sistema de Hist√≥rico
        async function loadHistory() {
            try {
                const actionFilter = document.getElementById('historyActionFilter').value;
                const periodFilter = document.getElementById('historyPeriodFilter').value;
                
                let query = supabaseClient
                    .from('item_history')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                // Aplicar filtros
                if (actionFilter) {
                    query = query.eq('action', actionFilter);
                }

                if (periodFilter && periodFilter !== 'all') {
                    const daysAgo = new Date();
                    daysAgo.setDate(daysAgo.getDate() - parseInt(periodFilter));
                    query = query.gte('created_at', daysAgo.toISOString());
                }

                const { data, error } = await query;

                if (error) throw error;

                historyItems = data || [];
                renderHistory();
                
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
            }
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            
            if (historyItems.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center">Nenhum hist√≥rico encontrado</p>';
                return;
            }
            
            list.innerHTML = historyItems.map(item => `
                <div class="bg-gray-50 rounded-xl p-4 border-l-4 border-blue-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-gray-800">${getActionText(item.action)}</h4>
                            <p class="text-gray-600 text-sm">${item.item_title}</p>
                            <p class="text-gray-400 text-xs mt-2">${formatDate(item.created_at)}</p>
                        </div>
                        <span class="text-2xl">${getActionIcon(item.action)}</span>
                    </div>
                </div>
            `).join('');
        }

        function getActionText(action) {
            const actions = {
                'created': 'Item criado',
                'updated': 'Item atualizado',
                'deleted': 'Item removido',
                'completed': 'Item marcado como comprado'
            };
            return actions[action] || action;
        }

        function getActionIcon(action) {
            const icons = {
                'created': '‚ûï',
                'updated': '‚úèÔ∏è',
                'deleted': 'üóëÔ∏è',
                'completed': '‚úÖ'
            };
            return icons[action] || 'üìù';
        }

        // Sistema de Compartilhamento
        async function shareList() {
            try {
                // Criar link de compartilhamento
                const shareData = {
                    title: 'Minha Lista de Desejos',
                    text: 'Confira minha lista de desejos no Whitelist!',
                    url: window.location.href
                };

                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // Fallback para copiar link
                    await navigator.clipboard.writeText(window.location.href);
                    alert('‚úÖ Link copiado para a √°rea de transfer√™ncia!');
                }

                // Registrar a√ß√£o no hist√≥rico
                await addHistoryEntry('shared', 'Lista compartilhada');
                
            } catch (error) {
                console.error('Erro ao compartilhar:', error);
                // Fallback simples
                const url = window.location.href;
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('‚úÖ Link copiado para a √°rea de transfer√™ncia!');
            }
        }

        // Fun√ß√£o auxiliar para adicionar entrada no hist√≥rico
        async function addHistoryEntry(action, itemTitle) {
            try {
                const { error } = await supabaseClient
                    .from('item_history')
                    .insert([{
                        user_id: currentUser.id,
                        action: action,
                        item_title: itemTitle,
                        details: `A√ß√£o realizada por ${currentUser.user_metadata?.full_name || 'Usu√°rio'}`
                    }]);

                if (error) throw error;
                
            } catch (error) {
                console.error('Erro ao adicionar hist√≥rico:', error);
            }
        }

        // Fun√ß√£o auxiliar para formatar datas
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'Hoje';
            if (diffDays === 2) return 'Ontem';
            if (diffDays <= 7) return `${diffDays - 1} dias atr√°s`;
            
            return date.toLocaleDateString('pt-BR');
        }

        // Event listener para o formul√°rio
        document.getElementById('addItemForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newItem = {
                title: document.getElementById('itemTitle').value.trim(),
                description: document.getElementById('itemDescription').value.trim(),
                price: document.getElementById('itemPrice').value.trim(),
                image: document.getElementById('itemImage').value.trim(),
                link: document.getElementById('itemLink').value.trim(),
                category: document.getElementById('itemCategory').value
            };
            
            if (newItem.title && newItem.category) {
                addWishItem(newItem);
                this.reset();
            } else if (!newItem.category) {
                alert('Por favor, selecione uma categoria!');
            }
        });

        // Fechar modal ao clicar fora
        document.getElementById('itemModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Fun√ß√£o para criar notifica√ß√µes
        async function createNotification(title, message) {
            try {
                const { error } = await supabaseClient
                    .from('notifications')
                    .insert([{
                        user_id: currentUser.id,
                        title: title,
                        message: message,
                        read: false
                    }]);

                if (error) throw error;
                
                // Recarregar notifica√ß√µes
                await loadNotifications();
                
            } catch (error) {
                console.error('Erro ao criar notifica√ß√£o:', error);
            }
        }

        // Event listeners para filtros em tempo real
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('categoryFilter').addEventListener('change', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);

        // Event listeners para hist√≥rico
        document.getElementById('historyActionFilter').addEventListener('change', loadHistory);
        document.getElementById('historyPeriodFilter').addEventListener('change', loadHistory);

        // Carregar a lista quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>
